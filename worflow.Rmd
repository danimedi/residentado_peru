---
title: "Workflow"
output: html_notebook
---

```{r setup, include=FALSE}
# packages
library(readr)
library(dplyr)
library(tibble)
library(magrittr)
library(stringr)
library(purrr)

# source multiple functions in the code directory
source2 <- function(...) {
  funs <- unlist(list(...))
  scripts <- paste0("code/", funs)
  purrr::walk(scripts, source)
}
```

## Organization

The main directories in the project are `code` and `data`, containing the scripts/functions and data for the files.

### Data organization

-   Raw files include the PDF files and other raw files that are not useful or programmable at first hand.

-   Clean data contains processed data created to program or work with it. It is divided in 'identified' and 'deidentified' data, depending on the presence or absence of names, DNI, or other identifiers.

## Extract and clean the data from PDF tables

```{r read-pdf}
source2("read_pdf_tables.R")
read_pdf_tables(path_input_pdf = "data/raw", 
                path_output_csv = "data/clean/identified")
```

## Unify the data

```{r unify-applicants}
source2("unify_data_sets.R")
files <- list.files("data/clean/identified", full.names = TRUE, 
                     pattern = "postulantes[.]csv$")
years <- 2013:2020
applicants <- unify_data_sets(files, years)
# write_csv(applicants, "data/clean/identified/peru-postulantes-2013-2020.csv")
```

```{r unify-incomings}
files <- list.files("data/clean/identified", full.names = TRUE, 
                     pattern = "ingresantes[.]csv$")
years <- 2016:2020
incomings <- unify_data_sets(files, years)
# write_csv(incomings, "data/clean/identified/peru-ingresantes-2016-2020.csv")
```

```{r unify-everything}
# subset rows with codigo (year 2016)
incomings1 <- incomings %>% filter(year == "2016")
applicants1 <- applicants %>% filter(year %in% as.character(2013:2016))
x <- full_join(applicants1, incomings1, by = c("year", "Codigo"), 
               suffix = c("_postulantes", "_ingresantes"))

# subset rows without codigo
incomings2 <- incomings %>% filter(year != "2016")
applicants2 <- applicants %>% filter(!year %in% as.character(2013:2016))
y <- full_join(applicants2, incomings2, by = c("year", "No Doc."),
               suffix = c("_postulantes", "_ingresantes"))

# join both pieces
dat_joined <- bind_rows(x, y)

# check that important columns have the same values
check_cols <- function(df, cols) {
  df_filt <- df %>% select(starts_with(cols))
  lapply(seq(1, length(df_filt), 2), function(i) {
    col_name <- names(df_filt[i])
    j <- df_filt[[i]] != df_filt[[i+1]]
    problems <- tibble(
      indx = which(j),
      x = as.character(df_filt[[i]][indx]),
      y = as.character(df_filt[[i+1]][indx])
    )
    list(col_name, problems = problems)
  })
}
columns <- c("Apellido Paterno", "Apellido Materno", "Nombres", "Universidad",
             "Tipo", "Especialidad", "V11", "Modalidad", "Serum", "Bonif")
# check_cols(dat_joined, columns)

dat_final <- dat_joined %>% 
  select(
    year, Codigo, `No Doc.`, CMP, `Apellido Paterno_postulantes`, 
    `Apellido Materno_postulantes`, Nombres_postulantes, Universidad_postulantes,
    Universidad_ingresantes, Tipo_postulantes, 
    `Especialidad/SubEspecialidad_postulantes`,
    `Especialidad/SubEspecialidad_ingresantes`, Serum_postulantes, 
    Bonif._postulantes, V9, V11_postulantes, V11_ingresantes, V13,
    Modalidad_postulantes, Modalidad_ingresantes, Norma, O.M., untaje, SNCDS,
    `1er Niv.`, `5to Sup.`, `Prom Pre`, ENAM, Estado, `Esp. Previa`, Examen,
    `Factor A.`, `ota Fina`, Obs., No_ingresantes, rden, .xame, Ajuste, P.Final,
    ngres, Sede
  ) %>% rename(
    apellido_paterno = `Apellido Paterno_postulantes`, 
    apellido_materno = `Apellido Materno_postulantes`,
    num_doc = `No Doc.`, nombres = Nombres_postulantes, tipo = Tipo_postulantes,
    especialidad_subespecialidad_postulantes = `Especialidad/SubEspecialidad_postulantes`, especialidad_subespecialidad_ingresantes = `Especialidad/SubEspecialidad_ingresantes`,
    serum = Serum_postulantes, bonificacion = Bonif._postulantes,
    puntaje = untaje, primer_nivel = `1er Niv.`, quinto_superior = `5to Sup.`,
    promedio_pregrado = `Prom Pre`, especialidad_previa = `Esp. Previa`,
    nota_final = `ota Fina`, observaciones = Obs., orden = rden, examen2 = .xame,
    promedio_final = P.Final, ingreso = ngres
  )
# deal with the columns `ingreso` and `examen2` of the year 2016
dat_2016 <- dat_final %>% filter(year == "2016")
dat_2016$Examen <- dat_2016$examen2
dat_final[dat_final$year == "2016", ] <- dat_2016
dat_final <- dat_final %>% select(!c(ingreso, examen2))
```

After processing there were 67 rows with a lot of missing values, those were people with different IDs between the different data sets (postulantes vs. ingresantes).

```{r}
# find the phantom data in the final data
# `i` evaluates the data that is present in the final data but it's not present in the applicants data
i <- !((dat_final$year %in% applicants$year) & 
  (dat_final$apellido_paterno %in% applicants$`Apellido Paterno`) & 
  (dat_final$apellido_materno %in% applicants$`Apellido Materno`))
phantom_dat <- dat_final[i, ]

# reveal identity and join data
x <- incomings[incomings$`No Doc.` %in% phantom_dat$num_doc, ]
fixed_phantom <- left_join(x, applicants, 
                           by = c("year", "Apellido Paterno", "Apellido Materno"),
                           suffix = c("_ingresantes", "_postulantes"))
# remove empty columns
k <- map_lgl(fixed_phantom, ~ all(is.na(.x)))
fixed_phantom <- fixed_phantom[,!k]
# rename columns to join the rows
fixed_phantom <- fixed_phantom %>% 
  rename(
    apellido_paterno = `Apellido Paterno`, 
    apellido_materno = `Apellido Materno`, nombres1 = Nombres_postulantes,
    nombres2 = Nombres_ingresantes, tipo1 = Tipo_postulantes,
    tipo2 = Tipo_ingresantes,
    especialidad_subespecialidad_postulantes = `Especialidad/SubEspecialidad_postulantes`, especialidad_subespecialidad_ingresantes = `Especialidad/SubEspecialidad_ingresantes`,
    serum = Serum_postulantes,
    primer_nivel = `1er Niv.`, quinto_superior = `5to Sup.`,
    promedio_pregrado = `Prom Pre`,
    nota_final = `ota Fina`
  )
# deal with nombres2, tipo2, No Doc., Codigo
jump_cols <- function(dat, cols) {
  h <- is.na(dat[[cols[1]]]) & !is.na(dat[[cols[2]]])
  dat[h, cols[1]] <- dat[h, cols[2]]
  dat
}
fixed_phantom <- fixed_phantom %>% 
  jump_cols(c("nombres1", "nombres2")) %>% 
  jump_cols(c("tipo1", "tipo2")) %>% 
  jump_cols(c("No Doc._ingresantes", "No Doc._postulantes")) %>% 
  select(
    !c(nombres2, tipo2, `No Doc._postulantes`, No_ingresantes, Obser.,
       No_postulantes)
  ) %>% 
  rename(nombres = nombres1, tipo = tipo1, num_doc = `No Doc._ingresantes`,
         Codigo = Codigo_postulantes)
# be sure that there are no new columns
length(setdiff(names(fixed_phantom), names(dat_final))) == 0

# remove the phantom data and its conections in the main data set and add the new clean phantom data
# `i` evaluates the data that is present in the final data but it's not present in the applicants data
i <- !((dat_final$year %in% applicants$year) & 
  (dat_final$apellido_paterno %in% applicants$`Apellido Paterno`) & 
  (dat_final$apellido_materno %in% applicants$`Apellido Materno`))
# `j` evaluates the data that is present in the final data and also in the phantom data, it shows the "identity" of the phantom data
j <- (dat_final$year %in% x$year) & 
  (dat_final$apellido_paterno %in% x$`Apellido Paterno`) & 
  (dat_final$apellido_materno %in% x$`Apellido Materno`)
# remove both of them, the phantom data and its connections and add the new "clean" phantom data
l <- i | j
dat_final <- bind_rows(dat_final[!l, ], fixed_phantom)

# write_csv(dat_final, "data/clean/identified/peru-COMPLETO-2013-2020")
```

## Transform the data

### De-identification

```{r}
dat <- read_csv("data/clean/identified/peru-COMPLETO-2013-2020")
```

### Reduce the data set

### Obtain gender from names

Gender was obtained from the first name, the sources were a list of names according to sex from Wikipedia ([Nombres masculinos](https://es.wikipedia.org/wiki/Categor%C3%ADa:Nombres_masculinos), [Nombres femeninos](https://es.wikipedia.org/wiki/Categor%C3%ADa:Nombres_femeninos)) and a list from [GitHub](https://github.com/MatthiasWinkelmann/firstname-database). The gender of the remaining names was assigned by hand if it was clear. This information was condensed into one data set with two columns: `name` and `gender`.

```{r}
genders <- read_csv("data/clean/first_name-gender_dictionary.csv")
head(genders)
dim(genders)
```

Then we can obtain the gender in the "main" data set using the **first names**.

```{r}
dat <- read_csv("data/clean/identified/peru-COMPLETO-2013-2020",
                col_types = cols(.default = col_character()))
head(dat)
```

```{r assign-gender}
# remove accents
str_to_english <- function(x) {
  x %>% 
    stringr::str_to_lower() %>% 
    stringi::stri_trans_general(id = "Latin-ASCII")
}

# obtain first name
first_names <- dat$Nombres %>% 
  str_extract("\\w+") %>% 
  str_to_lower() %>% 
  str_to_lower()

# create a column with the genders according with this first names
lookup <- setNames(genders$gender, genders$name)
x <- lookup[first_names] %>% unname()
dat2 <- mutate(dat, gender = x)
head(dat2)
```
